[{"content":"我是Neil，本科毕业于中国传媒大学信息与通信工程学院，目前在香港城市大学修读硕士学位。\n","permalink":"https://neilyuan0404.github.io/zh/about/","summary":"\u003cp\u003e我是Neil，本科毕业于中国传媒大学信息与通信工程学院，目前在香港城市大学修读硕士学位。\u003c/p\u003e","title":"关于"},{"content":"我的母校： 中国传媒大学 香港城市大学\n","permalink":"https://neilyuan0404.github.io/zh/links/","summary":"\u003cp\u003e我的母校：\n\u003ca href=\"https://www.cuc.edu.cn/\"\u003e中国传媒大学\u003c/a\u003e\n\u003ca href=\"https://www.cityu.edu.hk/\"\u003e香港城市大学\u003c/a\u003e\u003c/p\u003e","title":"友链"},{"content":"","permalink":"https://neilyuan0404.github.io/zh/threadpool/","summary":"","title":"Threadpool"},{"content":"纸上得来终觉浅，绝知此事要躬行。\n内容介绍 一、（已更）从CS:APP ProxyLab这辆玩具车出发 Github - Naive-Proxy的实现\n二、（已更）尝试改进玩具车Proxy：线程与I/O复用 Github - Mature-Proxy的实现\n本篇内容适合了解一点点C/C++，学过CS:APP的朋友们，亦或者有大二程度的计算机网络基础，想要了解更多实用的网络编程的朋友们。 本文是一个庞大知识体系的引子，为了可读性，我不得不牺牲很大一部分的细节，但是别担心，对于那些感兴趣的朋友，我会在适当的地方插入超链接。\n也许你只是认真学习了本科所教的计算机网络这门课，但是觉得从第一章开始就被各种概念填满的这门课无外乎是计算机专业中的一门\u0026quot;文科\u0026quot;，记一记，背一背，在考试顺利通过之后，并没能认识到这门课到底有何实用意义。亦或者你是刚学完CS:APP的网络编程一章并且实现了ProxyLab之后，总觉意犹未尽，因为短短几百行的ProxyLab实在是有一点太玩具，其功能也无法超乎教学需求之外。对于前者，建议先尝试花一些时间好好看看第一节和第二节的内容。\n一、从CS:APP ProxyLab这辆玩具车出发 1.1 互联网 互联网是一个极其庞大且复杂的通信网络系统，也是人类最伟大的工程学奇迹之一。到底有多少人使用互联网？到底有多少台设备相互连接？我相信，无论多少次列举这个至今仍在迅速增长的数字，都会让人深深地感受到不可思议：\n互联网已有超过53亿用户,占世界总人口的百分之67\n43亿IPv4地址耗尽时刻\n如果说实现如此规模庞大的复杂系统之间端到端的通信，只需要掌握几十个简单的函数，你是不是会相信这个世界也存在魔法？\n计算机世界的魔法之一，就是封装\n问：考虑主机A如何将数据传送到主机B：\n应用层：把数据打包（HTTP/FTP等） 传输层：加上端口号（TCP/UDP） 网络层：加上IP地址，选择路径 链路层：加上MAC地址，变成帧 物理层：变成电信号/光信号发送 A → 交换机 → 路由器 → 更多路由器 → 交换机 → B\n在这个过程中数据被层层封装，经过路由交换，最终解包送达。\n如果内核会说话，那么以上将会是他给出的答案，这是从计算机网络协议栈的视角来看。从一个程序员的视角，神奇的内核为我们提供了网络编程所需要的几十条极其简单的函数调用，我们将通过回顾CSAPP的ProxyLab，来帮助你理解所需要知道最基本的实用网络编程知识。\n1.2 网络编程基础 当神奇内核和封装魔法为我们屏蔽掉了实际网络中的复杂度，主机A与主机B之间的通信就变成了一种端到端问答对话，高度概括来说，我们引入客户端-服务器模型\n这种端到端的对话需要一个基本的信息，就是(客户端IP地址：端口, 服务器IP地址：端口)，由于结构上将客户端的信息和服务器的信息套接在一起，所以被称为套接字(socket)。\n1 struct sockaddr_in { 2 uint16_t sin_family; /* 协议族 (AF_INET) */ 3 uint16_t sin_port; /* 16位端口信息(大端法表示) */ 4 struct in_addr sin_addr; /* 32位IP地址信息(大端法表示) */ 5 unsigned char sin_zero[8]; /* struct sockaddr大小*/ 6 }; 7 8 /* 通用套接字地址结构 (用于connect函数, bind函数, 和accept函数) */ 9 struct sockaddr { 10 uint16_t sa_family; /* 协议族 */ 11 char sa_data[14]; /* 地址数据 */ 12 };\t图1.1 socket套接字地址结构\n有些奇怪的地方，不妨可以问问Deepseek：\n为什么明明可以用uint32_t直接表示IP地址，但是却使用struct in_addr这种东西？\n计算机系统中明明通行小端法表示字节顺序，但是套接字当中却统一使用大端法？\n为什么定义了struct sockaddr_in 还需要 struct sockaddr?\n我们将ProxyLab作为基本套接字网络应用的引子，边做边学。 什么是Proxy？\u0026mdash;-Proxy是代理服务器的名称，试比较我们之前提到的客户端-服务器模型：\n真实客户端 → Proxy → 真实服务器\n可以看到，Proxy的定位就是在客户端与服务器之间充当中间人，之所以要强调真实客户端以及真实服务器，是因为Proxy对客户端而言是虚拟服务器，而对于服务器而言，是虚拟客户端。，所以，ProxyLab其实是两重的服务器客户端模型。所以，其实我们只需要了解那个最基本的客户端-服务器模型具体如何工作，就能够理解ProxyLab了，为此，我们需要了解一些套接字接口函数，还有一个概念：*描述符：网络编程中的描述符就是一个整数\u0026quot;门票号\u0026quot;，它是操作系统用来唯一标识和管理网络连接（如Socket）的依据，应用程序通过它来操作对应的网络连接。\n套接字接口函数\nsocket函数：客户端或者服务器都可调用，返回一个非负的socket套接字描述符，创建起通信双方的一个端点，默认认为是客户端调用的，并理解为主动描述符 客户端用以连接服务器的函数：\nconnect函数：调用时阻塞，直到建立起连接或者返回错误，如果成功，则将通过socket函数创建的描述符变为已连接的客户端描述符clientfd，建议使用getaddrinfo函数为它提供参数 服务器用于同客户端建立连接的函数：\nbind函数：联系起socket_addr(服务器套接字地址)与socket套接字描述符，成功则返回0，否则-1\nlisten函数：若服务器调用此函数，则将通过socket函数创建的描述符从默认的主动描述符转化为监听描述符listenfd，同样建议使用getaddrinfo来提供参数\naccept函数：等待来自客户端的连接请求到达监听描述符listenfd，到达后，在socket_addr当中填写客户端的套接字地址，并返回已连接描述符connfd\n有了这些基本的工具，我们就可以建立起一个Naive版本的Proxy。具体代码就不在这贴了，附上连接，有比较详细的注释。 Github - Naive-Proxy的实现\n二、尝试改进Naive-proxy：线程与I/O复用 为什么将我们上面的proxy取名为naive？考虑如下两个问题：\n问题一、多个客户端并发请求服务器正在监听的某一端口，naive-proxy会如何？\n问题二、这些并发请求中，若处理某一个客户端的请求需要分配高性能时，naive-proxy会如何？\n我希望用一个现实中的例子来模拟：假设客户端连接是等待打饭的学生，我们的proxy或webserver是饭堂工作人员：\n首先，让我们来考虑问题一，naive-proxy的天真之处之一就在于它假设客户端的请求将会十分有序，就像在食堂捧着餐盘排队的学生们。但是，事实不是如此，高并发才是proxy或者webserver需要面对的常态，换句话说，当学生们不再彬彬有礼，客客气气，而是和三天没吃饭的饿死鬼一样蜂拥而上。我们可怜的饭堂阿姨也只能一边给手伸得最长、盘子递得最前的饿死鬼拍一勺饭，一边大声却无济于事地喝斥排队。\n然后，我们考虑问题二：naive-proxy的天真之处之二在于它假设客户端的请求一定是自己hold得住的、可以在合理时间内服务完毕的，假设这回，它遇到了一个请求资源十分大的连接请求：比方食堂阿姨遇到了一个奇怪的同学，他身材黝黑矮小，却拖着一个几乎和他体型一样大的麻袋，不问不知道，原来里面装着全班人的餐盘！这回不只是阿姨傻眼了，蜂拥而上的同学们也在旁边傻眼了\u0026mdash;-只能眼巴巴看着阿姨先给这位同学的全班打饭。\n当然了，对于食堂打饭的问题，如果我们有足够多的食堂窗口，并且聘请足够多的食堂阿姨，然后请思政老师好好把关学生素质，让他们自觉遵守校规，不是什么难事。但是计算机世界不是这样运作的！\n我们为proxy提供的解决方案如下：\n针对问题一：使用I/O复用技术，关键在于select函数来监控多个描述符的状态，这样我们就直到应该处理哪些个连接请求\n针对问题二：使用线程池技术，关键在于不同请求类型都可创建线程占用一个CPU执行\nselect如何使用 select是一个用于监视多个socket事件的系统调用，其所处理的数据结构是描述符集合fd_set, 并且修改fd_set中描述符的状态变化(它所监控的状态有三种\u0026mdash;-可读、可写、异常)。\nfd_set是什么？\n本质上，fd_set 是一个固定大小的位数组（bit array）。每一个位（bit）代表一个文件描述符。\n如果某个位被设置为 1，表示对应的文件描述符正在被监视。\n如果为 0，则表示不关心该文件描述符。\n例如，在一个 1024 位的 fd_set 中：\n位 0 (第1位) 代表文件描述符 0 (标准输入)\n位 5 (第6位) 代表文件描述符 5，以此类推\u0026hellip;\n在 Linux 中，fd_set 的大小通常是固定的，由常量 FD_SETSIZE 定义。 这个值通常是 1024。这意味着 select 能同时监视的文件描述符数量上限是 1024。\n1#include \u0026lt;sys/select.h\u0026gt; 2 3int select(int nfds, fd_set *readfds, fd_set *writefds, 4 fd_set *exceptfds, struct timeval *timeout); //timeout是可选项 图2.1 select函数原型\n通过一些宏，我们可以操作描述符集合:\nFD_ZERO(\u0026amp;set): 清空集合\nFD_SET(fd, \u0026amp;set): 添加文件描述符到集合\nFD_CLR(fd, \u0026amp;set): 从集合中移除文件描述符\nFD_ISSET(fd, \u0026amp;set): 检查文件描述符是否在集合中\n线程的简单介绍 线程是一种运行在进程上下文当中的逻辑流，也就是说，不同的线程只不过是同一进程之中的切换，共享这个进程当中的整个虚拟地址空间的所有内容。\n1int main() { 2\tpthread_t tid; //线程号tid 3\tPthread_create(\u0026amp;tid, NULL, thread, NULL); //线程创建 4\tPthread_join(tid, NULL); //调用线程 5\texit(0); 6} 7 8//线程所执行的内容 9void *thread(void *vargp) { 10\tprintf(\u0026#34;hello world\\n\u0026#34;); 11\treturn NULL; 12} 图2.2 线程版本的hello world\nmature-proxy 当中所涉及的线程代码十分简单，不过值得多嘴一提：\nPthread_join调用的时候，会发生阻塞，直到线程tid的内容执行完毕，然后返回一个指向通用（void）指针，在hello程序当中，这个指针指向的位置是NULL。然后，线程所使用的资源被回收。\n线程是可结合的或者分离的，一个可结合的线程能够被其他线程所回收和杀死，然而，一个分离的线程所占用的资源只能在其终止时被系统自然释放。我们可以通过int pthread_detach(pthread_t tid)函数来创建一个分离的线程，如果我们需要分离这个线程他自己，可以通过pthread_self函数来获取自己的tid。\n在mature-proxy当中，我们用线程改进naive-proxy的思路是创建一些线程池，也就是说，为了避免需要使用线程的时候我们还需要临时创建这种情况，我们提前创建了合理数目的线程，并且在需要使用的时候直接就可以使用。这种方法被称为线程池。\n有兴趣了解线程池技术的朋友，可以参考下我写的另一篇有关线程池的文章。\n","permalink":"https://neilyuan0404.github.io/zh/blog/proxylab/","summary":"\u003cp\u003e\u003cem\u003e纸上得来终觉浅，绝知此事要躬行。\u003c/em\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"内容介绍\"\u003e内容介绍\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e一、（已更）从CS:APP ProxyLab这辆玩具车出发  \u003ca href=\"https://github.com/NeilYuan0404/csapplabs/blob/main/proxylab/proxylab-handout/naive-proxy.c\"\u003eGithub - Naive-Proxy的实现\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e二、（已更）尝试改进玩具车Proxy：线程与I/O复用 \u003ca href=\"https://github.com/NeilYuan0404/csapplabs/blob/main/proxylab/proxylab-handout/mature-proxy.c\"\u003eGithub - Mature-Proxy的实现\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e本篇内容适合了解一点点C/C++，学过CS:APP的朋友们，亦或者有大二程度的计算机网络基础，想要了解更多实用的网络编程的朋友们。\n本文是一个庞大知识体系的引子，为了可读性，我不得不牺牲很大一部分的细节，但是别担心，对于那些感兴趣的朋友，我会在适当的地方插入超链接。\u003c/p\u003e\n\u003cp\u003e也许你只是认真学习了本科所教的计算机网络这门课，但是觉得从第一章开始就被各种概念填满的这门课无外乎是计算机专业中的一门\u0026quot;文科\u0026quot;，记一记，背一背，在考试顺利通过之后，并没能认识到这门课到底有何实用意义。亦或者你是刚学完CS:APP的网络编程一章并且实现了ProxyLab之后，总觉意犹未尽，因为短短几百行的ProxyLab实在是有一点太玩具，其功能也无法超乎教学需求之外。对于前者，建议先尝试花一些时间好好看看第一节和第二节的内容。\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"一从csapp-proxylab这辆玩具车出发\"\u003e一、从CS:APP ProxyLab这辆玩具车出发\u003c/h2\u003e\n\u003ch3 id=\"11-互联网\"\u003e1.1 互联网\u003c/h3\u003e\n\u003cp\u003e互联网是一个极其庞大且复杂的通信网络系统，也是人类最伟大的工程学奇迹之一。到底有多少人使用互联网？到底有多少台设备相互连接？我相信，无论多少次列举这个至今仍在迅速增长的数字，都会让人深深地感受到不可思议：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://en.wikipedia.org/wiki/List_of_countries_by_number_of_Internet_users\"\u003e互联网已有超过\u003cem\u003e53亿\u003c/em\u003e用户,占世界总人口的百分之67\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://cloud.tencent.com/developer/news/483642\"\u003e\u003cem\u003e43亿\u003c/em\u003eIPv4地址耗尽时刻\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e如果说实现如此规模庞大的复杂系统之间端到端的通信，只需要掌握\u003cem\u003e几十个\u003c/em\u003e简单的函数，你是不是会相信这个世界也存在魔法？\u003c/p\u003e\n\u003cp\u003e计算机世界的魔法之一，就是\u003cstrong\u003e封装\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e问：考虑主机A如何将数据传送到主机B：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e应用层：把数据打包（HTTP/FTP等）\u003c/li\u003e\n\u003cli\u003e传输层：加上端口号（TCP/UDP）\u003c/li\u003e\n\u003cli\u003e网络层：加上IP地址，选择路径\u003c/li\u003e\n\u003cli\u003e链路层：加上MAC地址，变成帧\u003c/li\u003e\n\u003cli\u003e物理层：变成电信号/光信号发送\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eA → 交换机 → 路由器 → 更多路由器 → 交换机 → B\u003c/p\u003e\n\u003cp\u003e在这个过程中数据被层层\u003cstrong\u003e封装\u003c/strong\u003e，经过路由交换，最终解包送达。\u003c/p\u003e\n\u003cp\u003e如果内核会说话，那么以上将会是他给出的答案，这是从计算机网络协议栈的视角来看。从一个程序员的视角，神奇的内核为我们提供了网络编程所需要的几十条极其简单的函数调用，我们将通过回顾CSAPP的ProxyLab，来帮助你理解所需要知道最基本的实用网络编程知识。\u003c/p\u003e\n\u003ch3 id=\"12-网络编程基础\"\u003e1.2 网络编程基础\u003c/h3\u003e\n\u003cp\u003e当神奇内核和封装魔法为我们屏蔽掉了实际网络中的复杂度，主机A与主机B之间的通信就变成了一种端到端问答对话，高度概括来说，我们引入\u003cstrong\u003e客户端-服务器模型\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e这种端到端的对话需要一个基本的信息，就是(客户端IP地址：端口, 服务器IP地址：端口)，由于结构上将客户端的信息和服务器的信息套接在一起，所以被称为\u003cstrong\u003e套接字\u003c/strong\u003e(socket)。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-C\" data-lang=\"C\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr_in\u003c/span\u003e  \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kt\"\u003euint16_t\u003c/span\u003e        \u003cspan class=\"n\"\u003esin_family\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"cm\"\u003e/* 协议族 (AF_INET) */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kt\"\u003euint16_t\u003c/span\u003e        \u003cspan class=\"n\"\u003esin_port\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"cm\"\u003e/* 16位端口信息(大端法表示) */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ein_addr\u003c/span\u003e  \u003cspan class=\"n\"\u003esin_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"cm\"\u003e/* 32位IP地址信息(大端法表示) */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e   \u003cspan class=\"n\"\u003esin_zero\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e8\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e \u003cspan class=\"cm\"\u003e/* struct sockaddr大小*/\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"cm\"\u003e/* 通用套接字地址结构 (用于connect函数, bind函数, 和accept函数) */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kt\"\u003euint16_t\u003c/span\u003e  \u003cspan class=\"n\"\u003esa_family\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"cm\"\u003e/* 协议族 */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kt\"\u003echar\u003c/span\u003e      \u003cspan class=\"n\"\u003esa_data\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e14\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e  \u003cspan class=\"cm\"\u003e/* 地址数据 */\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\t\t\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e图1.1 socket套接字地址结构\u003c/p\u003e","title":"CSAPP：ProxyLab讲解与实现"},{"content":"IP地址是网络层通信的基础，但是并不方便人类记忆，所以需要DNS域名系统来实现将IP地址和DNS之间的解析，简单来说，域名解析分为两个关键步骤：\n本机向本地域名服务器发送一个请求报头（header） 本地域名服务器返回一个响应报文（response），其中包含了IP地址 第一个步骤比较关键，因为构造请求报头的内容需要我们熟悉相关协议的内容和结构，而解析响应报文的代码一般比较固定，在实际项目中可以直接借用，并不需要做深入理解。为了用UDP来发送报文，我们还需要一些网络编程的知识，本文集中了介绍请求报文所应该包含的内容，并且使用C语言实现，如果你缺乏基本的网络编程知识可以看我的另一篇文章：CSAPP网络编程章节实验：Proxylab\nDNS请求报文格式 根据上图，我们可以知道请求报头（Header）中应该包含的内容有：transaction id、flags、questions、anwers、authority、additional，值得注意的是长度为16，所以使用short类型。\n1struct dns_header { 2 3 unsigned short id; 4 unsigned short flags; 5 6 unsigned short question; 7 unsigned short answer; 8 9 unsigned short authority; 10 unsigned short additional; 11 12}; 我们的正文（queries）中，name存放了需要查询的名称，比如www.google.com，这个的长度是不固定的，也就是说，如果超出了32，是可以拓展的。\n1struct dns_question { 2 3 int length; 4 unsigned short qtype; 5 unsigned short qclass; 6 unsigned char *name; 7 8}; 这些内容中，有一些是比较关键的，比如name不能直接使用www.google.com，而需要构造成特别的形式：3www6google3com，这样比较便于DNS服务器进行递归查询。有一些则不那么重要，比如authority， type之类的，不需要记住。\n创建报头函数 1int dns_create_header(struct dns_header *header) { 2 if (header == NULL) return -1; 3 memset(header, 0, sizeof(struct dns_header)); 4 5 //随机id即可 6 srandom(time(NULL)); 7 header-\u0026gt;id = random(); 8 9 //调整为网络字节序 10 header-\u0026gt;flags = htons(0x0100); 11 header-\u0026gt;question = htons(1); 12 13 return 0; 14} 关键技术阐述：当我们进行网络编程的时候，一定要注意使用htons函数进行网络字节序的转化（比如第11行），即从小端序，转为大端序\n大端序：最高有效字节存储在最低的内存地址（“大端在前”）。\n举例：数值 0x12345678 在内存中的存储顺序（从低地址到高地址）：12 34 56 78 网络字节序就是采用这种格式 小端序：最低有效字节存储在最低的内存地址（“小端在前”）。\n举例：数值 0x12345678 在内存中的存储顺序（从低地址到高地址）：78 56 34 12 x86/x64架构的PC采用这种格式 创建DNS查询函数 1int dns_create_question(struct dns_question *question, const char *hostname) { 2 3 if (question == NULL || hostname == NULL) return -1; 4 memset(question, 0, sizeof(struct dns_question)); 5 6 question-\u0026gt;name = (char*)malloc(strlen(hostname) + 2); 7 if (question-\u0026gt;name == NULL) { 8 return -2; 9 } 10 11 question-\u0026gt;length = strlen(hostname) + 2; 12 //网络字节序 13 question-\u0026gt;qtype = htons(1); 14 question-\u0026gt;qclass = htons(1); 15 16 17 // name,查询名字格式:3www6google3com 18 const char delim[2] = \u0026#34;.\u0026#34;; 19 char *qname = question-\u0026gt;name; 20 //复制hostname以方便操作 21 char *hostname_dup = strdup(hostname); 22 char *token = strtok(hostname_dup, delim); 23 24 while (token != NULL) { 25 26 size_t len = strlen(token); 27 28 *qname = len; 29 qname ++; 30 31 strncpy(qname, token, len+1);//这里已经包括了最后的\u0026#39;\\0\u0026#39; 32 qname += len; 33 34 token = strtok(NULL, delim); 35 36 } 37 38 free(hostname_dup); 39 return 0; 40} 关键技术阐述：以上代码中的22到37行实现了域名格式的转换，实现的关键在于使用strtok函数，这个函数的功能是从前往后查找delim所在位置，一旦遇到，就将delim前的内容返回，得到token。定义delim为“.”的时候，就会将www返回到token当中。同样的道理，使用while循环不断向后寻找google和com这两个token，并且将长度返回到指定的字符串qname的位置上，最后我们就获得了需要的查询名格式。\n提交DNS请求 将header和question整合进request里之后，就可以提交DNS请求了。\n1int dns_client_commit(const char *domain) { 2 int sockfd = socket(AF_INET, SOCK_DGRAM, 0); 3 4 if (sockfd \u0026lt; 0) { 5 return -1; 6 } 7 8 struct sockaddr_in servaddr = {0}; 9 servaddr.sin_family = AF_INET; 10 servaddr.sin_port = htons(DNS_SERVER_PORT); 11 servaddr.sin_addr.s_addr = inet_addr(DNS_SERVER_IP); 12 13 int ret = connect(sockfd, (struct sockaddr*) \u0026amp;servaddr, sizeof(servaddr)); 14 printf(\u0026#34;connect: %d\\n\u0026#34;, ret); 15 16 struct dns_header header = {0}; 17 dns_create_header(\u0026amp;header); 18 19 struct dns_question question = {0}; 20 dns_create_question(\u0026amp;question, domain); 21 //将header和question整合进request里 22 char request[1024] = {0}; 23 int length = dns_build_request(\u0026amp;header, \u0026amp;question, request, 1024); 24 25 //提交DNS请求 26 int slen = sendto(sockfd, request, length, 0, (struct sockaddr*) \u0026amp;servaddr, sizeof(struct sockaddr_in)); 27 28 //recvfrom函数，接收DNS服务器的响应 29 char response[1024] = {0}; 30 struct sockaddr_in addr; 31 size_t addr_len = sizeof(struct sockaddr_in); 32 33 int n = recvfrom(sockfd, response, sizeof(response), 0, (struct sockaddr*) \u0026amp;addr, (socklen_t*) \u0026amp;addr_len); 34 35 printf(\u0026#34;recvfrom : %d, %s\\n\u0026#34;, n, response); 36 37 return n; 38} 关键技术阐述：这些代码是比较固定的创建一个套接字连接的方式，（2～6行）先使用socket函数返指定使用的IPv4（参数AF_INET）、UDP（SOCK_DGARM）的协议，成功后返回socket描述符。（8～17行）然后指定servaddr结构体当中的内容：包括端口，DNS服务器的IP以及所使用的协议族。值得注意的是，13～14行使用了connect，其实在UDP编程中，并不必须要设置好connect，因为不需要像TCP一样三次握手，但是为了方便调试，还是先建立连接。最后，（16行以后）调用我们之前实现的header构造函数和整合函数后发送请求到DNS服务器，用recvfrom接收回应报文即可。\n","permalink":"https://neilyuan0404.github.io/zh/blog/udp/","summary":"\u003cp\u003eIP地址是网络层通信的基础，但是并不方便人类记忆，所以需要DNS域名系统来实现将IP地址和DNS之间的解析，简单来说，域名解析分为两个关键步骤：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e本机向本地域名服务器发送一个请求报头（header）\u003c/li\u003e\n\u003cli\u003e本地域名服务器返回一个响应报文（response），其中包含了IP地址\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e第一个步骤比较关键，因为构造请求报头的内容需要我们熟悉相关协议的内容和结构，而解析响应报文的代码一般比较固定，在实际项目中可以直接借用，并不需要做深入理解。为了用UDP来发送报文，我们还需要一些网络编程的知识，本文集中了介绍\u003cstrong\u003e请求报文所应该包含的内容，并且使用C语言实现\u003c/strong\u003e，如果你缺乏基本的网络编程知识可以看我的另一篇文章：\u003ca href=\"https://juejin.cn/post/7570058831559131171\"\u003eCSAPP网络编程章节实验：Proxylab\u003c/a\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"dns请求报文格式\"\u003eDNS请求报文格式\u003c/h3\u003e\n\u003cp\u003e\u003cimg alt=\"DNS请求报文格式\" loading=\"lazy\" src=\"/images/dns_header.png\"\u003e\u003c/p\u003e\n\u003cp\u003e根据上图，我们可以知道请求报头（Header）中应该包含的内容有：transaction id、flags、questions、anwers、authority、additional，值得注意的是长度为16，所以使用short类型。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-dns.c\" data-lang=\"dns.c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003edns_header\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eshort\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eshort\u003c/span\u003e \u003cspan class=\"n\"\u003eflags\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eshort\u003c/span\u003e \u003cspan class=\"n\"\u003equestion\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eshort\u003c/span\u003e \u003cspan class=\"n\"\u003eanswer\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eshort\u003c/span\u003e \u003cspan class=\"n\"\u003eauthority\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eshort\u003c/span\u003e \u003cspan class=\"n\"\u003eadditional\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg alt=\"查询\" loading=\"lazy\" src=\"/images/queries.png\"\u003e\u003c/p\u003e\n\u003cp\u003e我们的正文（queries）中，name存放了需要查询的名称，比如www.google.com，这个的长度是不固定的，也就是说，如果超出了32，是可以拓展的。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-dns.c\" data-lang=\"dns.c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003edns_question\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e3\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003elength\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e4\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eshort\u003c/span\u003e \u003cspan class=\"n\"\u003eqtype\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e5\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eshort\u003c/span\u003e \u003cspan class=\"n\"\u003eqclass\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e6\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e7\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e这些内容中，有一些是比较关键的，比如name不能直接使用www.google.com，而需要构造成特别的形式：3www6google3com，这样比较便于DNS服务器进行递归查询。有一些则不那么重要，比如authority， type之类的，不需要记住。\u003c/p\u003e\n\u003ch3 id=\"创建报头函数\"\u003e创建报头函数\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-dns.c\" data-lang=\"dns.c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003edns_create_header\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003edns_header\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eheader\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eheader\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nf\"\u003ememset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eheader\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003edns_header\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e//随机id即可\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nf\"\u003esrandom\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003etime\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"n\"\u003eheader\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003erandom\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e//调整为网络字节序\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"n\"\u003eheader\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eflags\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003ehtons\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mh\"\u003e0x0100\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"n\"\u003eheader\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003equestion\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003ehtons\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003e关键技术阐述\u003c/strong\u003e：当我们进行网络编程的时候，一定要注意使用htons函数进行网络字节序的转化（比如第11行），即从小端序，转为大端序\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e大端序：最高有效字节存储在最低的内存地址（“大端在前”）。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e举例：数值 \u003ccode\u003e0x12345678\u003c/code\u003e 在内存中的存储顺序（从低地址到高地址）：\u003ccode\u003e12 34 56 78\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e网络字节序就是采用这种格式\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e小端序：最低有效字节存储在最低的内存地址（“小端在前”）。\u003c/p\u003e","title":"用UDP实现向DNS服务器请求IP地址"},{"content":"HTTP协议是最被广泛使用的网络传输协议，所有的www文件都必须遵守这个标准，并且，HTTP基于TCP/IP通信协议来传递数据，本文的主要内容是介绍HTTP请求的的格式，并且使用C语言以TCP的方式来实现请求的发送。\n创建套接字 HTTP协议是应用层的协议，而其传输接口层的实现需要通过创建套接字。\n1int http_create_socket(char *ip) { 2 3 int sockfd = socket(AF_INET, SOCK_STREAM, 0); 4 5 struct sockaddr_in sin = {0}; 6 sin.sin_family = AF_INET; 7 sin.sin_port = htons(80);//http协议默认是80端口 8 sin.sin_addr.s_addr = inet_addr(ip);//将char*转化为无符号int 9 10 if (0 != connect(sockfd, (struct sockaddr*)\u0026amp;sin, sizeof(struct sockaddr_in))) { 11 return -1; 12 } 13 14 fcntl(sockfd, F_SETFL, O_NONBLOCK);//设置为非阻塞 15 16 return sockfd; 17} 关键技术阐述：上述代码的第3行调用socket函数用以创建套接字描述符，其中第一个参数指定使用IPv4， 第二个参数SOCK_STREAM指定后，默认使用TCP（而不是UDP）协议进行传输，第三个参数一般是具体协议选择，设置为0让系统自行决定即可。\n5～12行为相对固定的编程套路，填充好套接字地址sockaddr_in这个结构体的相关内容，与本文相关唯一值得注意的点是，HTTP默认使用80端口。\n第14行使用fcntl（file control函数）将连接设置为非阻塞。如果socket是阻塞的，read（）的时候整个程序挂起，等待io数据到来，反之则不会。使用到的时候查询下这个函数的参数如何设置即可，不需要特别记忆。\nHTTP请求报文的一般格式 发送http请求的函数实现如下 1char* http_send_request(const char *hostname, const char *resource) { 2 3 char *ip = host_to_ip(hostname); 4 int sockfd = http_create_socket(ip); 5 6 char buffer[BUFFER_SIZE] = {0}; 7 sprintf(buffer, 8\t\u0026#34;GET %s %s\\r\\n\\ 9\tHost: %s\\r\\n\\ 10\t%s\\r\\n\\ 11\t\\r\\n\u0026#34;, 12\tresource, HTTP_VERSION, 13\thostname, 14\tCONNECTION_TYPE 15\t); 16 17 send(sockfd, buffer, strlen(buffer), 0); 18 19 //select负责检测网络io里面有没有可读的数据 20 fd_set fdread; 21 FD_ZERO(\u0026amp;fdread); //描述符集置空 22 FD_SET(sockfd, \u0026amp;fdread); 23 24 struct timeval tv; 25 tv.tv_sec = 5; 26 tv.tv_usec = 0; 27 28 char *result = malloc(sizeof(int)); 29 memset(result, 0, sizeof(int)); 30 31 while (1) { 32 //用法：select(maxfd+1, \u0026amp;rset, \u0026amp;wset, \u0026amp;eset, NULL); 33 int selection = select(sockfd+1, \u0026amp;fdread, NULL, NULL, \u0026amp;tv); 34 if (!selection || !FD_ISSET((sockfd), \u0026amp;fdread)) { 35 break; 36 } else { 37 memset(buffer, 0, BUFFER_SIZE); 38 int len = recv(sockfd, buffer, BUFFER_SIZE, 0); 39 if (len == 0) { 40\tbreak; 41 } 42 43 result = realloc(result, (strlen(result) + len + 1)); 44 strncat(result, buffer, len); 45 } 46 } 47 return result; 48} 关键技术阐述：第6～15行：像TCP这种协议，数据的传输是一串一串的发送和到来的，更准确的描述是数据流，所以为了应对数据流断断续续到达的情况，需要使用到缓冲区buffer。而http请求内容符合我们上面那张图的格式即可。这里我们为了可读性和可维护性，使用了两个define：\n#define HTTP_VERSION \u0026quot;HTTP/1.1\u0026quot; #define CONNECTION_TYPE \u0026quot;Connection: close\\r\\n\u0026quot; 19～22行，之前讲过，本文中采用的是非阻塞的实现（read的时候不会挂起，系统继续其他的工作），所以我们可以搭配使用select函数（用于监听socket描述符）实现事件驱动，避免了忙轮询占用大量系统资源。有关细节可以看我的另一篇文章：CSAPP网络编程章节实验：Proxylab\n第24～26行设置了一个超时的时间为5s，超过这个时间断开连接。避免无意义的等待。\n第31～41行用while（1）循环反复读取服务器响应的内容，直到len等于0读取完毕打破循环退出。\n","permalink":"https://neilyuan0404.github.io/zh/blog/tcp/","summary":"\u003cp\u003eHTTP协议是最被广泛使用的网络传输协议，所有的www文件都必须遵守这个标准，并且，HTTP基于TCP/IP通信协议来传递数据，本文的主要内容是介绍HTTP请求的的格式，并且使用C语言以TCP的方式来实现请求的发送。\u003c/p\u003e\n\u003ch2 id=\"创建套接字\"\u003e创建套接字\u003c/h2\u003e\n\u003cp\u003eHTTP协议是应用层的协议，而其传输接口层的实现需要通过创建套接字。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-http.c\" data-lang=\"http.c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003ehttp_create_socket\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eip\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esockfd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003esocket\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAF_INET\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSOCK_STREAM\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr_in\u003c/span\u003e \u003cspan class=\"n\"\u003esin\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"n\"\u003esin\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esin_family\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eAF_INET\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"n\"\u003esin\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esin_port\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003ehtons\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e80\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//http协议默认是80端口\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"n\"\u003esin\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esin_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003es_addr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003einet_addr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eip\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//将char*转化为无符号int\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"nf\"\u003econnect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esockfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esin\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esockaddr_in\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nf\"\u003efcntl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esockfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eF_SETFL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eO_NONBLOCK\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e//设置为非阻塞\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003esockfd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003e关键技术阐述\u003c/strong\u003e：上述代码的第3行调用socket函数用以创建套接字描述符，其中第一个参数指定使用IPv4， 第二个参数SOCK_STREAM指定后，默认使用TCP（而不是UDP）协议进行传输，第三个参数一般是具体协议选择，设置为0让系统自行决定即可。\u003c/p\u003e\n\u003cp\u003e5～12行为相对固定的编程套路，填充好套接字地址sockaddr_in这个结构体的相关内容，与本文相关唯一值得注意的点是，HTTP默认使用80端口。\u003c/p\u003e\n\u003cp\u003e第14行使用fcntl（file control函数）将连接设置为非阻塞。如果socket是阻塞的，read（）的时候整个程序挂起，等待io数据到来，反之则不会。使用到的时候查询下这个函数的参数如何设置即可，不需要特别记忆。\u003c/p\u003e\n\u003ch2 id=\"http请求报文的一般格式\"\u003eHTTP请求报文的一般格式\u003c/h2\u003e\n\u003cp\u003e\u003cimg alt=\"HTTP请求报文的一般格式\" loading=\"lazy\" src=\"/images/http_header.png\"\u003e\u003c/p\u003e\n\u003ch4 id=\"发送http请求的函数实现如下\"\u003e发送http请求的函数实现如下\u003c/h4\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-http.c\" data-lang=\"http.c\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 1\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"nf\"\u003ehttp_send_request\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ehostname\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eresource\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 2\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 3\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003ehost_to_ip\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ehostname\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 4\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esockfd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003ehttp_create_socket\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eip\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 5\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 6\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eBUFFER_SIZE\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 7\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nf\"\u003esprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 8\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t  \u003cspan class=\"s\"\u003e\u0026#34;GET %s %s\u003c/span\u003e\u003cspan class=\"se\"\u003e\\r\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e 9\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e\t  Host: %s\u003c/span\u003e\u003cspan class=\"se\"\u003e\\r\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e10\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e\t  %s\u003c/span\u003e\u003cspan class=\"se\"\u003e\\r\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e11\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"s\"\u003e\t  \u003c/span\u003e\u003cspan class=\"se\"\u003e\\r\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e12\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t  \u003cspan class=\"n\"\u003eresource\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eHTTP_VERSION\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e13\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t  \u003cspan class=\"n\"\u003ehostname\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e14\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t  \u003cspan class=\"n\"\u003eCONNECTION_TYPE\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e15\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t  \u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e16\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e17\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nf\"\u003esend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esockfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nf\"\u003estrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e18\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e19\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"c1\"\u003e//select负责检测网络io里面有没有可读的数据\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e20\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"n\"\u003efd_set\u003c/span\u003e \u003cspan class=\"n\"\u003efdread\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e21\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nf\"\u003eFD_ZERO\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003efdread\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e//描述符集置空\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e22\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nf\"\u003eFD_SET\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esockfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003efdread\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e23\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e24\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003etimeval\u003c/span\u003e \u003cspan class=\"n\"\u003etv\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e25\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"n\"\u003etv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etv_sec\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e26\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"n\"\u003etv\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etv_usec\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e27\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e28\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003emalloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e29\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nf\"\u003ememset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e30\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e31\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e32\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e//用法：select(maxfd+1, \u0026amp;rset, \u0026amp;wset, \u0026amp;eset, NULL);\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e33\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eselection\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003eselect\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esockfd\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003efdread\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003etv\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e34\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eselection\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"nf\"\u003eFD_ISSET\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003esockfd\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003efdread\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e35\u003c/span\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e36\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e37\u003c/span\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nf\"\u003ememset\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBUFFER_SIZE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e38\u003c/span\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003elen\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003erecv\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esockfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBUFFER_SIZE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e39\u003c/span\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elen\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e40\u003c/span\u003e\u003cspan class=\"cl\"\u003e\t\u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e41\u003c/span\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e42\u003c/span\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e43\u003c/span\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003erealloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003estrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003elen\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e44\u003c/span\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"nf\"\u003estrncat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e45\u003c/span\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e46\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e47\u003c/span\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"ln\"\u003e48\u003c/span\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003e关键技术阐述\u003c/strong\u003e：第6～15行：像TCP这种协议，数据的传输是一串一串的发送和到来的，更准确的描述是数据流，所以为了应对数据流断断续续到达的情况，需要使用到缓冲区buffer。而http请求内容符合我们上面那张图的格式即可。这里我们为了可读性和可维护性，使用了两个define：\u003c/p\u003e","title":"实现TCP发送HTTP请求"}]